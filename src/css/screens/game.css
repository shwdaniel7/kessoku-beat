/* Container Global da Tela de Jogo */
.game-screen {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
    /* Fundo com imagem escura */
    background-image: url('../../../assets/images/game_bg.jpg');
    background-size: cover;
    background-position: center;
}

/* Overlay escuro para focar na pista */
.game-screen::before {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle, rgba(0,0,0,0.6) 0%, #000 90%);
    z-index: 0;
}

/* UI do Topo (Score) */
.game-ui {
    position: absolute;
    top: 30px;
    left: 50px;
    z-index: 100;
    display: flex;
    flex-direction: column;
    gap: 10px;
    font-family: var(--font-display);
}

.score-box, .combo-box {
    text-align: left;
}

.label {
    font-size: 0.9rem;
    color: var(--color-ryo);
    letter-spacing: 2px;
    text-transform: uppercase;
}

#score-val {
    font-size: 2.5rem;
    color: white;
    text-shadow: 0 0 15px var(--theme-color); /* <--- MUDOU */
}

#combo-val {
    font-size: 3rem;
    color: var(--color-nijika);
    text-shadow: 0 0 15px var(--color-nijika);
}

/* --- A PISTA 3D --- */
.track-container {
    position: absolute;
    left: 50%;
    bottom: 0;
    /* O segredo do 3D: Perspective + RotateX */
    transform: translateX(-50%) perspective(1000px) rotateX(50deg);
    transform-origin: bottom;
    
    width: 500px;
    height: 100vh; /* Altura total */
    
    background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(20, 20, 30, 0.9) 40%);
    border-left: 2px solid var(--theme-color);
    border-right: 2px solid var(--theme-color);
    box-shadow: 0 0 50px rgba(232, 108, 166, 0.1);
    box-shadow: 0 0 50px var(--theme-color);
    
    display: flex;
    z-index: 10;
}

/* As 4 Linhas (Lanes) */
.lane {
    flex: 1;
    position: relative;
    border-right: 1px solid rgba(255,255,255,0.05);
}

.lane:last-child { border-right: none; }

/* Linha de Hit (Onde aperta) */
.hit-zone {
    position: absolute;
    bottom: 50px; /* Altura da linha */
    width: 100%;
    height: 10px;
    background: rgba(255,255,255,0.1);
    border-top: 2px solid var(--color-nijika);
    border-bottom: 2px solid var(--color-nijika);
    box-shadow: 0 0 15px var(--color-nijika);
    transition: transform 0.1s, background 0.1s;
}

/* Efeito ao apertar tecla */
.hit-active {
    background: var(--theme-color);
    box-shadow: 0 0 30px white;
    transform: scaleY(1.5);
}

/* Letras (D F J K) */
.key-hint {
    position: absolute;
    bottom: 10px;
    width: 100%;
    text-align: center;
    color: rgba(255,255,255,0.5);
    font-family: var(--font-display);
    font-size: 1.5rem;
    transform: skewX(-10deg); /* Estilo */
}

/* --- AS NOTAS --- */
/* --- AS NOTAS (OTIMIZADO) --- */
/* --- AS NOTAS (ULTRA OTIMIZADO) --- */
.note {
    position: absolute;
    left: 5%;
    top: 0;
    width: 90%;
    height: 20px;
    background: var(--theme-color);
    border-radius: 4px;
    z-index: 20;

    /* OTIMIZAÇÃO DE HARDWARE */
    will-change: transform;
    transform: translate3d(0, -200px, 0); /* Começa fora da tela */
    
    /* IMPORTANTE: Desativa transições CSS para não brigar com o JS */
    transition: none !important; 
    
    /* Esconde notas inativas sem remover do DOM (mais rápido) */
    visibility: hidden; 
    box-shadow: 0 0 15px var(--theme-color);
}

/* Quando a nota está em uso */
.note.active {
    visibility: visible;
}

/* Cores */
.note-center { background: var(--color-ryo); }

/* Efeitos (Simples para performance) */
.note-hit {
    opacity: 0;
    transform: scale(1.5);
    transition: transform 0.1s, opacity 0.1s !important; /* Aqui pode ter transição curta */
}

.note.note-hit {
    /* Faz a cabeça brilhar enquanto segura */
    box-shadow: 0 0 20px white !important;
    background-color: white !important;
}

.note-miss {
    background: #555 !important;
    opacity: 0.5;
}

/* Overlay de Contagem */
.game-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
}

.countdown {
    font-family: var(--font-display);
    font-size: 10rem;
    color: white;
    text-shadow: 0 0 50px var(--theme-color);
}

/* --- SISTEMA DE FEEDBACK VISUAL (V1.1) --- */

#feedback-container {
    position: absolute;
    top: 35%; /* Subi um pouco para não tampar as notas */
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 300;
    pointer-events: none;
    text-align: center;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.feedback-text {
    font-family: var(--font-display);
    font-size: 5rem; /* Maior */
    font-weight: 900;
    font-style: italic;
    text-transform: uppercase;
    opacity: 0;
    /* Stroke (borda) no texto para leitura melhor */
    -webkit-text-stroke: 2px rgba(0,0,0,0.5);
}

/* Animação mais explosiva */
.feedback-text {
    animation: feedbackPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes feedbackPop {
    0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
    40% { transform: scale(1.3) rotate(0deg); opacity: 1; }
    100% { transform: scale(1) translateY(-20px); opacity: 0; }
}

/* PERFECT - Dourado/Rosa Neon */
.feedback-text.perfect {
    background: linear-gradient(to bottom, #fff 0%, var(--color-bocchi) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 10px var(--theme-color)) drop-shadow(0 0 30px var(--theme-color));
    z-index: 302;
}

/* GOOD - Azul Neon */
.feedback-text.good {
    color: var(--color-ryo);
    -webkit-text-fill-color: var(--color-ryo);
    text-shadow: 0 0 20px var(--color-ryo);
    font-size: 3.5rem;
    z-index: 301;
}

.feedback-text.miss {
    color: #ff3333;
    -webkit-text-fill-color: #ff3333; /* Garante vermelho sólido */
    text-shadow: 0 0 20px red;
    font-size: 4rem; /* Bem grande */
    opacity: 1 !important; /* FORÇA A VISIBILIDADE */
    animation: feedbackMiss 0.5s forwards; /* Nova animação específica */
}

/* Nova animação: Cai um pouco e treme */
@keyframes feedbackMiss {
    0% { transform: scale(1.5) rotate(0deg); opacity: 1; }
    20% { transform: scale(1) rotate(-10deg); }
    40% { transform: scale(1) rotate(10deg); }
    60% { transform: scale(1) rotate(-10deg); opacity: 1; }
    100% { transform: scale(0.8) translateY(50px) rotate(0deg); opacity: 0; }
}

/* Animação do Combo (Pulsar) */
.combo-pulse {
    animation: comboBump 0.1s ease-out;
    color: var(--color-nijika) !important;
}

@keyframes comboBump {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); text-shadow: 0 0 20px white; }
    100% { transform: scale(1); }
}


/* =========================================
   LOW SPEC MODE (MODO LEVE / 2D)
   ========================================= */

/* Remove o fundo pesado e deixa estático */
body.low-spec .game-screen {
    background-image: none;
    background-color: #111;
}

/* Remove a perspectiva 3D da pista */
body.low-spec .track-container {
    transform: translateX(-50%) scale(1); /* Remove rotateX e perspective */
    bottom: 20px;
    height: 95vh;
    background: #000;
    border: 2px solid #444;
    box-shadow: none !important; /* Remove glow da pista */
}

/* Simplifica as linhas */
body.low-spec .lane {
    border-right: 1px solid #333;
}

/* Simplifica a linha de hit */
body.low-spec .hit-zone {
    background: transparent;
    border-top: 2px solid white;
    border-bottom: 2px solid white;
    box-shadow: none !important;
}

/* Simplifica as notas (Quadrados chapados, sem glow) */
body.low-spec .note {
    box-shadow: none !important; /* O MAIOR VILÃO DE PERFORMANCE É O BOX-SHADOW */
    border: 1px solid rgba(255,255,255,0.5); /* Borda para visibilidade */
    border-radius: 0;
}

/* Cores chapadas para as notas */
body.low-spec .note {
    background-color: #E86CA6 !important; /* Rosa sólido */
}
body.low-spec .note-center {
    background-color: #007ACC !important; /* Azul sólido */
}

/* Remove animações pesadas de feedback */
body.low-spec .feedback-text {
    text-shadow: none !important;
    filter: none !important;
}

/* Remove brilho do score */
body.low-spec #score-val, 
body.low-spec #combo-val {
    text-shadow: none !important;
}

/* =========================================
   NOTAS LONGAS
   ========================================= */
/* Corpo da nota longa */
.note-hold-body {
    position: absolute;
    width: 100%;
    /* A altura é definida via JS */
    
    /* --- CORREÇÃO AQUI --- */
    background: var(--theme-color); /* Usa a cor do personagem */
    opacity: 0.5; /* Deixa transparente aqui */
    
    border-left: 2px solid var(--theme-color);
    border-right: 2px solid var(--theme-color);
    /* --------------------- */

    top: 0;
    transform-origin: top;
    z-index: 19;
    pointer-events: none;
    box-shadow: 0 0 10px var(--theme-color); /* Adicionei um brilho leve */
}


/* Nota central longa */
.note-hold-body {
    border-color: var(--color-ryo);
}

.note-center {
    background: #fff; /* Deixei branco para destacar do tema colorido */
    box-shadow: 0 0 15px #fff;
    border-color: var(--color-ryo);
}

.note-holding {
    background-color: #fff !important; /* Fica branca */
    box-shadow: 0 0 20px #fff, 0 0 40px var(--theme-color) !important; /* Muito brilho */
    z-index: 30 !important; /* Fica por cima de tudo */
    transform: scale(1.1); /* Leve aumento */
    /* IMPORTANTE: Não tem opacity: 0 aqui! */
}

/* Garante que a cauda continue visível e brilhante */
.note-holding .note-hold-body {
    background: var(--theme-color);
    opacity: 0.8; /* Fica mais sólido quando aperta */
    border-color: white;
    box-shadow: 0 0 20px var(--theme-color);
}

/* Feedback de Spam (Erro por apertar sem nota) */
.spam-active {
    background: rgba(255, 0, 0, 0.5) !important;
    box-shadow: 0 0 20px red !important;
    border-color: red !important;
    transform: scaleY(0.8) !important; /* Efeito de "amassar" */
}

/* =========================================
   VISUAL OVERHAUL (V2.0)
   ========================================= */

/* --- LANE BEAMS (Canhões de Luz) --- */
.lane-beam {
    position: absolute;
    bottom: 50px; /* Começa na linha de hit */
    left: 0;
    width: 100%;
    height: 0%; /* Começa invisível */
    background: linear-gradient(to top, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0) 100%);
    pointer-events: none;
    z-index: 5;
    transition: height 0.1s ease-out, opacity 0.1s ease-out;
    opacity: 0;
}

/* Quando ativo */
.beam-active {
    height: 80% !important; /* Sobe até quase o topo */
    opacity: 1 !important;
}

/* Cores específicas por Lane (Opcional, mas fica lindo) */
#lane-0 .lane-beam { background: linear-gradient(to top, rgba(232, 108, 166, 0.6) 0%, transparent 100%); } /* Bocchi */
#lane-1 .lane-beam { background: linear-gradient(to top, rgba(230, 62, 62, 0.6) 0%, transparent 100%); }   /* Kita */
#lane-2 .lane-beam { background: linear-gradient(to top, rgba(0, 122, 204, 0.6) 0%, transparent 100%); }   /* Ryo */
#lane-3 .lane-beam { background: linear-gradient(to top, rgba(242, 214, 75, 0.6) 0%, transparent 100%); }  /* Nijika */

/* --- COMBO AURA (Vignette Dinâmica) --- */
.game-screen::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    z-index: 200;
    box-shadow: inset 0 0 0px rgba(0,0,0,0);
    transition: box-shadow 0.5s ease;
}

/* Nível 1: Combo 50+ (Azul Ryo Cool) */
.game-screen.aura-1::after {
    box-shadow: inset 0 0 50px rgba(0, 122, 204, 0.3);
}

/* Nível 2: Combo 100+ (Rosa Bocchi Power) */
.game-screen.aura-2::after {
    box-shadow: inset 0 0 100px rgba(232, 108, 166, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.2);
    animation: auraPulse 2s infinite;
}

@keyframes auraPulse {
    0% { opacity: 0.8; }
    50% { opacity: 1; }
    100% { opacity: 0.8; }
}

/* --- LOW SPEC MODE (Desliga tudo isso) --- */
body.low-spec .lane-beam { display: none !important; }
body.low-spec .game-screen::after { display: none !important; }

/* =========================================
   FEVER / OVERDRIVE SYSTEM
   ========================================= */

/* Container da Barra */
.fever-container {
    position: absolute;
    right: 50px; /* Fica na direita */
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 400px;
    background: rgba(0, 0, 0, 0.8);
    border: 2px solid #555;
    border-radius: 15px;
    overflow: hidden;
    z-index: 100;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

/* O líquido da barra (enche de baixo pra cima) */
.fever-fill {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 0%; /* JS vai mudar isso */
    background: linear-gradient(to top, var(--color-ryo), var(--color-bocchi));
    transition: height 0.2s ease-out;
    box-shadow: 0 0 20px var(--color-bocchi);
}

/* Texto "READY" quando enche */
.fever-text {
    position: absolute;
    bottom: -50px; /* Escondido */
    right: 35px;
    font-family: var(--font-display);
    color: #fff;
    font-size: 1.5rem;
    text-shadow: 0 0 10px gold;
    white-space: nowrap;
    transition: bottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* Estado: PRONTO PARA ATIVAR */
.fever-ready .fever-fill {
    background: linear-gradient(to top, gold, orange);
    box-shadow: 0 0 30px gold;
    animation: feverPulse 0.5s infinite alternate;
}

.fever-ready .fever-text {
    bottom: 50%; /* Sobe para o meio */
    transform: translateY(50%);
}

@keyframes feverPulse {
    from { opacity: 0.8; box-shadow: 0 0 20px gold; }
    to { opacity: 1; box-shadow: 0 0 50px gold; }
}

/* Estado: ATIVADO (DURANTE O FEVER) */
.game-screen.fever-active .track-container {
    border-color: gold;
    box-shadow: 0 0 80px rgba(255, 215, 0, 0.4);
}

.game-screen.fever-active .hit-zone {
    border-color: gold;
    box-shadow: 0 0 30px gold;
}

.game-screen.fever-active .fever-fill {
    background: white;
    box-shadow: 0 0 40px white;
}

/* Low Spec: Esconde a barra para não pesar */
body.low-spec .fever-container { display: none; }

/* --- KITA AURA CUT-IN --- */
.kita-cutin {
    position: absolute;
    bottom: 0;
    right: -500px; /* Estado inicial (fora da tela) */
    width: 500px;
    height: auto;
    z-index: 90;
    pointer-events: none;
    opacity: 0;
    
    /* TRANSIÇÃO DE SAÍDA (Suave e mais lenta) */
    transition: right 0.8s ease-in-out, opacity 0.5s ease-in-out;
}

.kita-cutin img {
    width: 100%;
    height: auto;
    filter: drop-shadow(0 0 30px gold) drop-shadow(0 0 10px white);
    animation: kitaFloat 2s infinite ease-in-out;
}

/* Classe para ativar */
.kita-cutin.active {
    /* Posição final (dentro da tela) */
    right: 150px; 
    opacity: 1;
    
    /* TRANSIÇÃO DE ENTRADA (Rápida e elástica) */
    transition: right 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s ease-out;
}

@keyframes kitaFloat {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-10px) scale(1.02); }
}

/* Low Spec: Não mostra para economizar */
body.low-spec .kita-cutin { display: none; }

/* --- CINEMATIC INTRO --- */
.cinematic-intro {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #000;
    z-index: 500;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity 0.5s ease-out;
}

.intro-content {
    display: flex;
    align-items: center;
    gap: 40px;
}

.intro-cover {
    width: 300px; height: 300px;
    box-shadow: 0 0 50px rgba(255,255,255,0.1);
    opacity: 0;
    transform: scale(0.5) rotate(-10deg);
    animation: introCoverIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.2s forwards;
}

.intro-cover img { width: 100%; height: 100%; object-fit: cover; }

.intro-text {
    display: flex; flex-direction: column;
    align-items: flex-start;
}

.intro-title {
    font-family: var(--font-display);
    font-size: 4rem;
    color: white;
    text-transform: uppercase;
    opacity: 0;
    transform: translateX(50px);
    animation: introTextSlide 0.6s ease-out 0.5s forwards;
}

.intro-artist {
    font-family: var(--font-body);
    font-size: 1.5rem;
    color: var(--theme-color);
    letter-spacing: 5px;
    opacity: 0;
    transform: translateX(50px);
    animation: introTextSlide 0.6s ease-out 0.7s forwards;
}

.intro-line {
    width: 0%;
    height: 4px;
    background: var(--theme-color);
    margin-top: 10px;
    animation: introLineGrow 0.8s ease-out 0.8s forwards;
}

.intro-ready {
    position: absolute;
    bottom: 100px;
    font-family: var(--font-display);
    font-size: 5rem;
    color: white;
    text-shadow: 0 0 20px white;
    opacity: 0;
    transform: scale(2);
    transition: all 0.2s;
}

/* Animações */
@keyframes introCoverIn {
    to { opacity: 1; transform: scale(1) rotate(0deg); }
}

@keyframes introTextSlide {
    to { opacity: 1; transform: translateX(0); }
}

@keyframes introLineGrow {
    to { width: 100%; }
}

/* Fade In da UI do Jogo */
.fade-in-target {
    opacity: 0;
    transition: opacity 0.5s ease-in;
}

.fade-in-target.visible {
    opacity: 1;
}

/* --- BARRA DE VIDA (HP) - LADO ESQUERDO --- */
.hp-container {
    position: absolute;
    left: 40px; /* Moveu da direita para a esquerda */
    bottom: 40px; /* Alinhado por baixo */
    height: 400px; /* Mais alta */
    width: 40px;   /* Um pouco mais larga */
    display: flex;
    flex-direction: column-reverse; /* Preenche de baixo pra cima */
    align-items: center;
    z-index: 100;
    gap: 10px;
}

.hp-label {
    font-family: var(--font-display);
    color: var(--color-bocchi); /* Rosa da Bocchi */
    font-size: 1.2rem;
    letter-spacing: 2px;
    text-shadow: 0 0 10px var(--color-bocchi);
    transform: rotate(-90deg); /* Texto deitado */
    margin-bottom: 10px;
}

.hp-bar-bg {
    width: 100%;
    height: 100%;
    background: rgba(20, 0, 0, 0.6);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px; /* Borda redonda */
    overflow: hidden;
    position: relative;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
}

.hp-bar-fill {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%; 
    background: linear-gradient(to top, var(--theme-color), white); /* <--- MUDOU */
    box-shadow: 0 0 15px var(--theme-color); /* <--- MUDOU */
    transition: height 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 0 0 20px 20px;
}

/* Efeito de Perigo (Piscando vermelho quando < 30%) */
.hp-bar-fill.danger {
    background: linear-gradient(to top, #ff0000, #ff4444) !important;
    box-shadow: 0 0 30px red !important;
    animation: hpPulse 0.5s infinite alternate;
}

@keyframes hpPulse {
    from { opacity: 0.6; }
    to { opacity: 1; }
}

/* --- TELA DE GAME OVER (FAILED) --- */
#fail-overlay {
    background: radial-gradient(circle, rgba(50, 0, 0, 0.8) 0%, #000 100%);
    backdrop-filter: blur(10px);
    z-index: 1000;
}

/* Reutilizando a estrutura do pause-menu, mas com estilo específico para Fail */
#fail-overlay .pause-menu {
    background: rgba(20, 0, 0, 0.9);
    border: 1px solid red;
    box-shadow: 0 0 100px rgba(255, 0, 0, 0.2);
    transform: skewX(0deg) scale(1.1); /* Reto e maior */
    width: 500px;
    padding: 60px 40px;
    position: relative;
    overflow: hidden;
}

/* Linha decorativa de erro */
#fail-overlay .pause-menu::before {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 5px;
    background: red;
    box-shadow: 0 0 20px red;
}

#fail-overlay h2 {
    font-size: 5rem;
    color: red;
    text-shadow: 4px 4px 0px #500;
    margin-bottom: 10px;
    /* Efeito Glitch no texto */
    animation: glitchText 0.3s infinite;
}

#fail-reason {
    font-size: 1.2rem;
    color: #ffaaaa;
    letter-spacing: 5px;
    margin-bottom: 40px;
    text-transform: uppercase;
    border-bottom: 1px solid #500;
    padding-bottom: 20px;
    width: 100%;
}

/* Botões do Game Over */
#fail-overlay .btn-primary {
    background: transparent;
    border-color: red;
    color: red;
    width: 100%;
    margin-bottom: 15px;
}

#fail-overlay .btn-primary:hover {
    background: red;
    color: white;
    box-shadow: 0 0 30px red;
}

/* Animação de Glitch */
@keyframes glitchText {
    0% { transform: translate(0); }
    20% { transform: translate(-2px, 2px); }
    40% { transform: translate(-2px, -2px); }
    60% { transform: translate(2px, 2px); }
    80% { transform: translate(2px, -2px); }
    100% { transform: translate(0); }
}

.game-screen {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background-size: 100%; /* Começa normal */
    background-position: center;
    
    /* Transição ultra rápida para acompanhar a batida */
    transition: background-size 0.05s ease-out; 
}